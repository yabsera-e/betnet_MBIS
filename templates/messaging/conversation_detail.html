{% extends "newbase.html"%}

{% block content%}
{% load humanize %}

<div class="container  mx-auto px-4 sm:px-6 lg:px-20 ">
    <div>
        {% for participant in conversation.participants.all %}
            {% if participant != request.user %}
            <h3 class="text-xl font-semibold mb-4 text-center text-secondary">Conversation with {{ participant.first_name }} </h3>
            {%endif%}
        {%endfor%}
    </div>
    <!-- Listing Info -->
    <div class="flex flex-row sm:w-[50%] border border-lime-400 rounded-lg mx-auto shadow-lg gap-5 items-start p-4 bg-white">
        <!-- First Image Only -->
        {% with conversation.listing.medias.all|first as first_image %}
            {% if first_image %}
                <img class="h-20 w-20 sm:w-40 sm:h-40  object-cover rounded" src="{{ first_image.file_path }}" alt="Listing Image">
            {% endif %}
        {% endwith %}
    
        <div class="flex flex-col gap-2">
            <!-- Title and Status -->
            <div class="flex items-center gap-2">
                <span class="font-semibold">{{ conversation.listing.title }}</span>
                <span class="text-white text-xs font-semibold px-2.5 py-0.5 rounded 
                    {% if conversation.listing.status %} bg-green-400 
                    {% else %} bg-red-400 
                    {% endif %}">
                    {% if conversation.listing.status %} Available {% else %} Unavailable {% endif %}
                </span>
            </div>
    
            <!-- Price -->
            <span class=" font-semibold">
                {{ conversation.listing.price|floatformat:0|intcomma }} ETB
                <span class="text-sm font-light">/monthly</span>
            </span>
    
            <!-- Address -->
            <div class="flex items-center gap-2 text-gray-700 text-sm">
                <i class="fas fa-map-marker-alt text-secondary"></i>
                <span>{{ conversation.listing.area }}, {{ conversation.listing.sub_city }}, {{ conversation.listing.city }}</span>
            </div>
    
            <!-- View Details Link -->
            <a href="{% url 'listing_retrieve' conversation.listing.id %}" 
               class="text-teal-500 font-semibold text-sm hover:underline mt-2">
                View Details â†’
            </a>
        </div>
    </div>
    
    <ul class="space-y-4 mt-5 flex items-start flex-col">
        {% for message in messages %}
        <li class="inline-flex flex-col
            {% if message.author == request.user %}
                bg-lime-100 self-end
            {% else %}
                bg-amber-100 self-start
            {% endif %} shadow-sm p-4 rounded-b-xl rounded-tr-xl w-auto max-w-full">
            <span class="font-semibold mr-2">{{ message.author.first_name }}</span>
            <span class="">{{ message.content }}</span>
            <span class="text-xs text-gray-500">{{ message.created_at|timesince }} ago</span>
        </li>        
        {% empty %}
        <li>No messages yet.</li>
        {% endfor %}
    </ul>
    <form method="post" action="{% url 'send_message' pk=conversation.pk %}" class="mt-4">
        {% csrf_token %}
        <!-- <input type="text" name="content" placeholder="Type your message..." class=" w-full px-4 py-2 rounded border border-gray-300 focus:outline-none focus:border-lime-500"> -->
        {{form.as_p}}
        <button type="submit" class="mt-2 px-4 py-2 bg-secondary text-white rounded-lg hover:bg-teal-800 focus:outline-none focus:bg-lime-600">
            Send
            <i class="fas fa-paper-plane"></i>
        </button>
    </form>
</div>
{% endblock content%}
